{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% block title %} Rapat Kerja Teknis {% endblock %}
{% block content %}
<div class="breadcrumb">
  <div class="row">
    <h3 class="heading mb-2">Rapat Kerja Teknis</h3>
    <span class="mb-0">
      <span class="text-muted fw-light">Kegiatan /</span>
      <span class="ms-1 fw-medium">Rapat Kerja Teknis</span>
    </span>
  </div>
</div>

<section id="__data">
  <div class="card">
    <div class="card-body">
      <div id="headline" class="mb-3">
        <h3 class="text-center">
          KEGIATAN RAPAT KERJA TEKNIS PEMBERDAYAAN MASYARAKAT<br />
          <span id="currentYear"></span>
        </h3>
        <hr />
      </div>

      <div class="action-button">
        <div class="d-flex justify-content-end mb-3 gap-2">
          <button class="btn btn-success" data-bs-toggle="modal" onclick="handleExport()">
            <i class="fas fa-file-export me-2"></i>Ekspor Data
          </button>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="fas fa-plus me-2"></i>Tambah Data
          </button>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="mb-3">
            <label for="" class="form-label">Satuan Kerja Pelaksana</label>
            <input type="text" class="form-control" name="satker_pelaksana" data-bind="value:filter" />
          </div>

        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered" id="__table">
          <thead class="" style="background-color: #2ca8dc;">
            <tr>
              <th style="color: white;">NO</th>
              <th style="color: white;">SATKER PELAKSANA</th>
              <th style="color: white;">TANGGAL</th>
              <th style="color: white;">SATUAN KERJA YANG DIUNDANG</th>
              <th style="color: white;">DESKRIPSI</th>
              <th style="color: white;">KENDALA</th>
              <th style="color: white;">KESIMPULAN</th>
              <th style="color: white;">TINDAK LANJUT</th>
              <th style="color: white;">DOKUMENTASI</th>
              <th style="color: white;">AKSI</th>
            </tr>
          </thead>
          <tbody class="align-tr-middle text-white" data-bind="foreach:rakernisData">
            <tr class="table-primary">
              <td data-bind="text:$index()+1"></td>
              <td colspan="8"><span data-bind="text:satker.nama_satker"></span>
                (<span data-bind="text:data.length"></span> kegiatan)</td>
              <td>
                <div>
                  <a href="javascript:void(0);" style="background-color:#00A0A9;"
                    class="badge text-white text-decoration-none mb-1">
                    <i class="fa-regular fa-paper-plane me-2"></i>Kirim Semua
                  </a>
                </div>
              </td>
            </tr>
            <!-- ko foreach:data -->
            <tr>
              <td></td>
              <td></td>
              <td><span data-bind="text:tanggal_awal"></span>-<br /><span data-bind="text:tanggal_akhir"></span></td>
              <td data-bind="text:satker_target.nama_satker"></td>
              <td data-bind="text:deskripsi"></td>
              <td data-bind="text:kendala"></td>
              <td data-bind="text:kesimpulan"></td>
              <td data-bind="text:tindak_lanjut"></td>
              <td class="text-center"><a data-bind="attr: { href: dokumentasi}"><i class="fa-solid fa-download"></i></a>
              </td>
              <td>
                <div class="list-button gx-3 text-uppercase">
                  <div>
                    <a href="javascript:void(0);" data-bind="click: function() { handleEditModal(id) }"
                      class="badge bg-success text-white text-decoration-none mb-1">
                      <i class="fas fa-pen-to-square me-2"></i>Edit
                    </a>
                  </div>
                  <div>
                    <a href="javascript:void(0);" data-bind="click: function() { handleDelete2(id) }"
                      class="badge bg-danger text-white text-decoration-none mb-1">
                      <i class="fas fa-trash-alt me-2"></i>Hapus</a>
                  </div>
                </div>
              </td>
            </tr>
            <!-- /ko -->

            <!-- ko if: has_child -->
            <!-- ko foreach:detail -->
            <tr class="table-secondary">
              <td data-bind="text:'' + parseInt($parentContext.$index()+1) + '.' + parseInt($index()+1)"></td>
              <td colspan="8"><span data-bind="text:satker.nama_satker"></span> (<span
                  data-bind="text:data.length"></span> kegiatan)</td>
              <td>
                <div>
                  <a href="javascript:void(0);" style="background-color:#00A0A9;"
                    class="badge text-white text-decoration-none mb-1">
                    <i class="fa-regular fa-paper-plane me-2"></i>Kirim Semua
                  </a>
                </div>
              </td>
            </tr>
            <!-- ko foreach:data -->
            <tr>
              <td></td>
              <td></td>
              <td><span data-bind="text:tanggal_awal"></span>-<br /><span data-bind="text:tanggal_akhir"></span></td>
              <td data-bind="text:satker_target.nama_satker"></td>
              <td data-bind="text:deskripsi"></td>
              <td data-bind="text:kendala"></td>
              <td data-bind="text:kesimpulan"></td>
              <td data-bind="text:tindak_lanjut"></td>
              <td class="text-center">
                <a data-bind="attr: { href: dokumentasi, title: dokumentasi }"><i class="fa-solid fa-download"></i></a>
              </td>
              <td>
                <div class="list-button gx-3 text-uppercase">
                  <div>
                    <a href="javascript:void(0);" onclick="handleEditModal()"
                      class="badge bg-success text-white text-decoration-none mb-1">
                      <i class="fas fa-pen-to-square me-2"></i>Edit
                    </a>
                  </div>
                  <div>
                    <a href="javascript:void(0);" onclick="handleDelete()"
                      class="badge bg-danger text-white text-decoration-none mb-1"><i
                        class="fas fa-trash-alt me-2"></i>Hapus</a>
                  </div>
                </div>
              </td>
            </tr>
            <!-- /ko -->
            </tr>
            <!-- /ko -->
            <!-- /ko -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}
{% block js_tambahan %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
<script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>

<script>
  var vm = function () {
    self = this;
    this.rakernisData = ko.observableArray([]);

    this.filter = ko.observable('BNNP Jawa Barat');

    this.loadData = function () {
      axios.get(`/kegiatan/api/v1/psm/rakernis/?format=datatables`).then(function (response) {
        data = response.data.data;
        data.forEach(function (item) {
          if (item.detail.length == 0)
            item.has_child = false;
          else
            item.has_child = true;
        })
        self.rakernisData(data);
        console.log(self.rakernisData())
      });
    }
    self.loadData();
  };
  ko.applyBindings(vm);

  async function handleDate(event, target) {
    const currentDate = moment().format('YYYY-MM-DD');
    const valueDate = $(event.target).val();
    (valueDate === currentDate ? $(`#${target}tanggal_akhir`).attr('disabled', true) : $(`#${target}tanggal_akhir`).attr('disabled', false));
  }

  async function handlePost(e) {
    e.preventDefault();
    showSwalLoading();

    const tanggal_awal = $("#create__tanggal_awal").val();
    const tanggal_akhir = $("#create__tanggal_akhir").val();
    const satker = $("#create__satker").val();
    const satker_target = $("#create__satker_target").val();
    const deskripsi = $("#create__deskripsi").val();
    const kendala = $("#create__kendala").val();
    const kesimpulan = $("#create__kesimpulan").val();
    const tindak_lanjut = $("#create__tindak_lanjut").val();
    const dokumentasi = $("#create__dokumentasi")[0].files[0];

    const data = {
      satker,
      satker_target,
      tanggal_awal,
      tanggal_akhir,
      deskripsi,
      kendala,
      kesimpulan,
      tindak_lanjut,
      dokumentasi,
    };
    console.log(data);

    const formData = new FormData();

    formData.append("tanggal_awal", tanggal_awal);
    formData.append("tanggal_akhir", tanggal_akhir);
    formData.append("satker", parseInt(satker));
    formData.append("satker_target", parseInt(satker_target));
    formData.append("deskripsi", deskripsi);
    formData.append("kendala", kendala);
    formData.append("kesimpulan", kesimpulan);
    formData.append("tindak_lanjut", tindak_lanjut);
    formData.append("dokumentasi", dokumentasi);

    try {
      const response = await axios.post(
        `/kegiatan/api/v1/psm/rakernis/perform_create/`,
        formData,
        {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        }
      );

      $("div#createModal").modal("hide");
      showSwalSuccess(
        "Berhasil!",
        `Data kegiatan telah <b>berhasil</b> ditambahkan!`
      );
      window.location.reload()
    } catch (error) {
      showSwalGenericError();
      console.error("Terjadi kesalahan :", error);
    } finally {
      vm.loadData();
    }
  }

  async function handleEdit(e) {
    e.preventDefault();
    showSwalLoading();

    const id = $('#edit__id').val();
    const tanggal_awal = $("#edit__tanggal_awal").val();
    const tanggal_akhir = $("#edit__tanggal_akhir").val();
    const satker = $("#edit__satker").val();
    const satker_target = $("#edit__satker_target").val();
    const deskripsi = $("#edit__deskripsi").val();
    const kendala = $("#edit__kendala").val();
    const kesimpulan = $("#edit__kesimpulan").val();
    const tindak_lanjut = $("#edit__tindak_lanjut").val();
    const dokumentasi = $("#edit__dokumentasi")[0].files[0];

    const data = {
      id,
      satker,
      satker_target,
      tanggal_awal,
      tanggal_akhir,
      deskripsi,
      kendala,
      kesimpulan,
      tindak_lanjut,
      dokumentasi,
    };
    console.log(data);

    const formData = new FormData();


    formData.append("id", id);
    formData.append("tanggal_awal", tanggal_awal);
    formData.append("tanggal_akhir", tanggal_akhir);
    formData.append("satker", parseInt(satker));
    formData.append("satker_target", parseInt(satker_target));
    formData.append("deskripsi", deskripsi);
    formData.append("kendala", kendala);
    formData.append("kesimpulan", kesimpulan);
    formData.append("tindak_lanjut", tindak_lanjut);
    if (dokumentasi) { formData.append('dokumentasi', dokumentasi); }

    try {
      const response = await axios.patch(
        `/kegiatan/api/v1/psm/rakernis/perform_update/`, formData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      }
      );

      $("div#modalEdit").modal("hide");
      showSwalSuccess('Berhasil!', `Data kegiatan telah <b>berhasil</b> diperbarui!`);

    } catch (error) {
      showSwalGenericError();
      console.error("Terjadi kesalahan :", error);
    } finally {
      table.ajax.reload();
    }
  }

  async function handleEditModal(id) {
    try {
      const response = await axios.get(`/kegiatan/api/v1/psm/rakernis/get_detail_data/?id=${id}`);
      const data = response.data;

      $('#edit__id').val(data[0].id);
      $('#edit__tanggal_awal').val(data[0].tanggal_awal);
      $('#edit__tanggal_akhir').val(data[0].tanggal_akhir);
      (data[0].tanggal_akhir ? $('#edit__tanggal_akhir').attr('disabled', false) : $('#edit__tanggal_akhir').attr('disabled', true))
      $('#edit__satker').val(data[0].satker_id).trigger('change');
      $('#edit__satker_target').val(data[0].satker_target).trigger('change');
      $('#edit__deskripsi').val(data[0].deskripsi);
      $('#edit__kendala').val(data[0].kendala);
      $('#edit__kesimpulan').val(data[0].kesimpulan);
      $('#edit__tindak_lanjut').val(data[0].tindak_lanjut);

      console.log(data[0].id)

      $('#modalEdit').modal('show');
    } catch (error) {
      showSwalGenericError();
      console.error('Terjadi kesalahan :', error);
    }
  }

  async function handleKirim(data) {
    const confirmResult = await showSwalConfirm(`Apakah anda yakin untuk mengirim semua kegiatan dari Satuan Kerja <b>${data.nama}</b>`, 'Ya, kirim data');
    if (!confirmResult.isConfirmed) return;
    showSwalLoading();
    await sleep(1000);
    try {
      const response = await axios.post('/kegiatan/api/v1/psm/rakernis/kirim_kegiatan/', { satker_id: data.id });
      console.log('Respose :', response);
      const sendedToParent = response.data.parent.keterangan;
      showSwalSuccess('Berhasil', `Data <b>kegiatan</b> untuk <b>${data.nama}</b> telah berhasil <b>dikirimkan ke <b>${sendedToParent}</b></b>`);
      reloadAllDataTables();
    } catch (error) {
      showSwalGenericError();
      console.error('Terjadi kesalahan :', error);
    }
  }

  async function handleExport() {
    var tbl = document.getElementById('__table');
    /* create a workbook */
    var wb = XLSX.utils.table_to_book(tbl);
    /* export to file */
    XLSX.writeFile(wb, "SheetJSTable.xlsx");
  }

  async function handleDelete2(id) {
    const confirmationText = `Untuk menghapus data tersebut ${id}? <br> Data yang dihapus tidak dapat <b>dipulihkan</b> kembali`;

    const confirmResult = await showSwalConfirm(confirmationText, 'Ya, hapus data');

    if (!confirmResult.isConfirmed) return;

    showSwalLoading();

    await sleep(1000);

    try {
      const response = await axios.delete(`/kegiatan/api/v1/psm/rakernis/${id}/`);

      showSwalSuccess('Berhasil', `Data kegiatan berhasil <b>dihapus</b>`, 3000);
      window.location.reload()

    } catch (error) {
      console.log('Terjadi kesalahan : ', error);
      showSwalGenericError();
    } finally {
      $('.modal').modal('hide');
      reloadAllDataTables();
    }
  }
</script>

{% endblock %}
{% block modal_tambahan %}
{% include 'psm/rakernis/modals/create.html'%}
{% include 'psm/rakernis/modals/edit.html' %}
{% endblock %}