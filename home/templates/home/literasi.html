{% extends "home/home_base.html" %}
{% load static %}

{% block title %} Daftar Literasi {% endblock title %}
{% block container %} container-fluid {% endblock container %}

{% block modal_tambahan %}
{% include "home/modals/detail_literasi_modal.html" %}
{% endblock modal_tambahan %}

{% block content %}
<section id="literasi" class="px-4">

    <div class="container">
        <section id="heading" class="row align-items-center justify-content-center g-5 py-5" data-aos="fade-up">
            <div class="col-lg-2">
                <img src="{% static 'assets/home/images/literasi.png' %}" class="d-block mx-lg-auto img-fluid"
                    alt="Literasi Image" width="500" height="400" loading="eager" title="Literasi Image">
            </div>
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold text-body-emphasis lh-1 mb-3">Literasi</h1>
                <p class="mt-3 mb-4">
                    Berikut merupakan daftar literasi atau modul-modul yang disediakan oleh <b>Direktorat Pemberdayaan
                        Alternatif & Direktorat Peran Serta Masyarakat</b> dari
                    <b>Deputi Bidang Pemberdayaan Masyarakat</b>.</p>
            </div>
        </section>

        {% include "home/tables/literasi_table.html" %}
    </div>
</section>
{% endblock content %}

{% block js_tambahan %}
<script>
    const columns = [{
            data: 'judul',
            render: function (data, type, row) {
                const output = `<div class="detail_literasi">
                <h5>
                    ${data}
                </h5>
                <div class="detail_uploader">
                    Diunggah oleh:
                    <span class="text-muted text-uppercase">${row.created_by.first_name} ${row.created_by.last_name},
                        <span class="text-dark">DEPUTI BIDANG PEMBERDAYAAN MASYARAKAT BNN</span></span>
                </div>
            </div>`;

                return `${output}`;
            }
        },
        {
            data: 'jumlah_diunduh',
            render: function (data, type, row) {
                let output = `<span class="text-secondary">[<span class="text-dark">${data}</span><i
            class="fas fa-download ms-1 text-primary"></i>]</span>`;

                return `${output}`;
            }
        },
        {
            data: 'id',
            render: function (data, type, row) {
                return `
                <span onclick="handleDetail(${data})"
                class="btn btn-success w-100 btn-sm"><i class="fas fa-book-open"></i></span>
            `;
            }
        }
    ];

    const table = $('#__table').DataTable({
        language: dt_lang_config(),
        serverSide: true,
        searching: true,
        responsive: true,
        pageLength: 10,
        ajax: {
            url: '/dashboard/literasi/api/v1/?format=datatables&ordering=judul',
            dataSrc: 'data'
        },
        ordering: true,
        order: [
            [1, 'asc']
        ],
        columns: columns,
        initComplete: function (settings, json) {
            console.log('Hasil fetch data : ', json);
        },
        columnDefs: [{
            orderable: false,
            targets: [0, 1, 2]
        }]
    });
</script>
<script>
    var s = '';

    function getURL() {
        let modified_url = `/dashboard/literasi/api/v1/?format=datatables&ordering=judul`;
        if (s != '') {
            s = convertToTitleCaseAndReplaceSpace(s);
            modified_url += `&s=${s}`;
        } else {
            modified_url = '/dashboard/literasi/api/v1/?format=datatables&ordering=judul';
        }
        return modified_url;
    }

    $(function () {
        let timeoutId;

        $('#__table_wrapper input[type="search"]').on('keyup', function () {
            table.settings()[0].jqXHR.abort();

            clearTimeout(timeoutId);

            timeoutId = setTimeout(function () {

                s = $(this).val();

                const url = getURL();

                console.log('URL:', url);

                table.ajax.url(url).load();
            }.bind(this), 500);
        });

    });
</script>
<script>
    async function handleDetail(id) {
        const modal = $('#detailModal');

        const response = await axios.get(`/dashboard/literasi/api/v1/${id}/`);
        const data = response.data;

        const dokumenExt = data.dokumen.split('.').pop();

        modal.find('#detail_judul').text(data.judul);
        modal.find('#detail_wadah').attr('src', data.dokumen);
        modal.find('#detail_dokumen').attr('href', data.dokumen).attr('download', `${data.judul}`);

        await axios.get(`/dashboard/literasi/api/v1/${id}/increment_unduhan/`);

        modal.modal('show');
    }
</script>
{% endblock js_tambahan %}

{% block css_tambahan %}
{% include "home/plugins/datatable.html" %}
<style>
    hr.hr-muted {
        color: #959595;
    }

    table tbody td:nth-child(2),
    table tbody td:nth-child(3) {
        text-align: center;
    }

    /* Datatable override */
    table tbody {
        border-left: 0px solid #fff;
        border-right: 0px solid #fff;
    }

    #list_literasi_wrapper .row:nth-child(2) {
        margin: 1rem 0;
    }

    #list_literasi_wrapper .row:nth-child(3) {
        margin-bottom: 2rem;
    }
</style>
{% endblock css_tambahan %}